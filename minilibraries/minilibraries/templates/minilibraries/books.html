{% extends "base.html" %}

{% block title %}Books{% endblock %}

{% block content %}
<div id="search-panel">
    <h3>Search Filters</h3>
    <form>
        <input type="search" name="search" placeholder="Title" {% if request.GET.search %}value="{{request.GET.search}}"{% endif %}></input><br>
        <label for="order">Order</label>
        <select name="order">
            <option value="" {% if not request.GET.order %}selected {% endif %} disabled hidden>Choose here</option>
            <option {% if request.GET.order == "recent" %}selected {% endif %}value="recent">Date added (recent first)</option>
            <option {% if request.GET.order == "old" %}selected {% endif %}value="old">Date added (old first)</option>
            <option {% if request.GET.order == "AtoZ" %}selected {% endif %}value="AtoZ">Alphabetical (Ascending)</option>
            <option {% if request.GET.order == "ZtoA" %}selected {% endif %}value="ZtoA">Alphabetical (Descending)</option>
            <option {% if request.GET.order == "rand" %}selected {% endif %}value="rand">Random</option>
        </select><br>

        <input type="submit" value="Search"></input>
    </form>
</div>

<div class="page-center">
    <h2>Books</h2>
    <button id="reg-button">Register Book</button>
    <div class="nav">
        {% if page > 0 %}
        <a class="nav-button" href="{% url 'books' page|add:"-1" %}" style="margin-right: 50%;">&lt;</a>
        {% endif %}
        {% if is_more %}
        <a class="nav-button" href="{% url 'books' page|add:1%}" style="position: absolute;top: 0px;right: 0px;">&gt;</a>
        {% endif %}
    </div>
    <div id="books-container">
        {% for book in books %}
            <div class="book">
                <img src="https://covers.openlibrary.org/b/isbn/{{book.isbn}}-M.jpg" loading="lazy"><br>
                <a href="{% url 'book' book.id %}" target="_blank" class="book-title {% if book.borrower %}taken{% endif %}">{{book.title}}</a>
            </div>
        {% endfor %}
    </div>
    <div class="nav">
        {% if page > 0 %}
        <a class="nav-button" href="{% url 'books' page|add:"-1" %}" style="margin-right: 50%;">&lt;</a>
        {% endif %}
        {% if is_more %}
        <a class="nav-button" href="{% url 'books' page|add:1%}" style="position: absolute;top: 0px;right: 0px;">&gt;</a>
        {% endif %}
    </div>
</div>
<dialog id="reg-modal">
    <h1>Register Book</h1>
    <form class="form" id="reg">
        {% csrf_token %}
        {{ form }}
        <input type="submit" value="Submit">
    </form>
    <button id="reg-exit">Close</button>
</dialog>
<script>
    const reg_button = document.getElementById("reg-button");
    const reg_modal = document.getElementById("reg-modal");
    const reg_exit = document.getElementById("reg-exit");
    const form = document.getElementById("reg");
    const validation = /[^0-9Xx]/g;

    reg_button.addEventListener("click", () => {
        reg_modal.showModal();
    });

    reg_exit.addEventListener("click", () => {
        reg_modal.close();
    });

    form.addEventListener("submit", (e) => {
        e.preventDefault();
        let formData = new FormData(document.forms['reg']);
        let isbn = formData.get('isbn');
        let validated = isbn.replaceAll(validation, "")
        console.log(validated);
        formData.set('isbn', validated);

        const context = {method: "POST", body: formData};
        fetch('/book/add', context)
            .then((response) => response.text())
            .then((text) => {
                alert(text);
                reg.reset();
            });
    });
</script>
{% endblock %}